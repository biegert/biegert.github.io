<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Widget Editor</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f4f4; margin: 20px; }
    h2 { margin-bottom: 10px; }
    .container { display: flex; gap: 20px; }
    .editor, .preview { background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); flex: 1; }
    .section { margin-bottom: 20px; }
    label { font-weight: bold; display: block; margin: 8px 0 4px; }
    input[type="text"], textarea, select { width: 100%; padding: 6px; margin-bottom: 8px; border: 1px solid #ccc; border-radius: 4px; }
    button { padding: 6px 10px; margin: 5px 0; border: none; border-radius: 4px; background: #007BFF; color: #fff; cursor: pointer; }
    button.remove { background: #D32F2F; }
    .small-btn { font-size: 12px; padding: 4px 8px; }
    .card { max-width: 400px; background: #fff; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); overflow: hidden; }
    .widget-header { padding: 10px; display: flex; justify-content: space-between; color: #fff; }
    .widget-body { padding: 10px; }
    .widget-title { font-size: 20px; font-weight: bold; margin-bottom: 5px; }
    .widget-description { color: gray; font-size: 14px; margin-bottom: 10px; }
    .tab-nav { display: flex; border-bottom: 1px solid #ddd; }
    .tab-nav button { flex: 1; padding: 8px; background: none; border: none; cursor: pointer; font-weight: bold; }
    .tab-nav button.active { border-bottom: 2px solid #007BFF; color: #007BFF; }
    .tab-content { padding: 10px 0; }
    .row { margin-bottom: 10px; padding: 5px; border: 1px solid #eee; border-radius: 4px; }
    .optional-section { border-top: 1px solid #ddd; padding-top: 10px; margin-top: 10px; }
  </style>
</head>
<body>
  <h2>Widget Editor</h2>
  <div class="container">
    <div class="editor">
      <div class="section">
        <label for="category">Category</label>
        <input type="text" id="category" value="Operationsverfahren">
  
        <label for="department">Department</label>
        <input type="text" id="department" value="Abteilung Gynäkologie">
  
        <label for="title">Procedure Title</label>
        <input type="text" id="title" value="Cholecystectomy">
  
        <label for="description">Description</label>
        <textarea id="description" rows="2">Standard laparoscopic cholecystectomy procedure.</textarea>
  
        <label for="headingColor">Header Color</label>
        <select id="headingColor">
          <option value="#009688">Teal</option>
          <option value="#007BFF">Blue</option>
          <option value="#D32F2F">Red</option>
          <option value="#FF9800">Orange</option>
        </select>
      </div>
  
      <div class="section">
        <h3>Tabs (1–4)</h3>
        <div id="tabsContainer"></div>
        <button id="addTab">Add Tab</button>
      </div>
  
      <div class="section">
        <h3>Optional Sections (0–4)</h3>
        <div id="optContainer"></div>
        <button id="addOpt">Add Optional Section</button>
      </div>
  
      <button id="generateLink">Generate Embed Link</button>
      <div id="embedLinkContainer" style="margin-top: 10px;"></div>
    </div>
  
    <div class="preview">
      <h3>Live Preview</h3>
      <div class="card" id="previewCard">
        <div class="widget-header" id="previewHeader" style="background: #009688;">
          <div id="previewCategory">Operationsverfahren</div>
          <div id="previewDepartment">Abteilung Gynäkologie</div>
        </div>
        <div class="widget-body">
          <div class="widget-title" id="previewTitle">Cholecystectomy</div>
          <div class="widget-description" id="previewDescription">Standard laparoscopic cholecystectomy procedure.</div>
          <div class="tab-nav" id="previewTabNav"></div>
          <div class="tab-content" id="previewTabContent"></div>
          <div class="optional-section" id="previewOptional"></div>
        </div>
      </div>
    </div>
  </div>
  
  <script>
  // Global arrays to hold tab and optional section data.
  let tabs = []; // each tab: { id, name, rows: [{id, heading, content}] }
  let optSections = []; // each optional: { id, heading, content }
  let tabCounter = 0, optCounter = 0;
  const maxTabs = 4, minTabs = 1, maxOpts = 4;

  // Create a new tab with one default row.
  function createTab(name = "Tab " + (tabCounter+1)) {
    const tabId = tabCounter++;
    const tab = { id: tabId, name, rows: [] };
    addRowToTab(tab);
    tabs.push(tab);
    renderTabs();
  }

  // Add a new row to a given tab object.
  function addRowToTab(tab, heading = "", content = "") {
    const rowId = Date.now() + Math.random();
    tab.rows.push({ id: rowId, heading, content });
  }

  // Remove a row from a tab.
  function removeRowFromTab(tab, rowId) {
    if (tab.rows.length > 1) {
      tab.rows = tab.rows.filter(r => r.id !== rowId);
    }
  }

  // Render the tabs section.
  function renderTabs() {
    const container = document.getElementById("tabsContainer");
    container.innerHTML = "";
    tabs.forEach((tab, tabIndex) => {
      const tabDiv = document.createElement("div");
      tabDiv.className = "tab-block";
      tabDiv.style.border = "1px solid #ccc";
      tabDiv.style.padding = "10px";
      tabDiv.style.marginBottom = "10px";
      tabDiv.dataset.tabId = tab.id;

      // Tab header row
      const headerRow = document.createElement("div");
      headerRow.style.display = "flex";
      headerRow.style.justifyContent = "space-between";

      const nameInput = document.createElement("input");
      nameInput.type = "text";
      nameInput.value = tab.name;
      nameInput.style.flex = "1";
      nameInput.addEventListener("input", () => {
        tab.name = nameInput.value;
        updatePreview();
      });
      headerRow.appendChild(nameInput);

      // Remove button if more than minTabs.
      if (tabs.length > minTabs) {
        const removeTabBtn = document.createElement("button");
        removeTabBtn.textContent = "Remove";
        removeTabBtn.className = "remove small-btn";
        removeTabBtn.addEventListener("click", () => {
          tabs = tabs.filter(t => t.id !== tab.id);
          renderTabs();
          updatePreview();
        });
        headerRow.appendChild(removeTabBtn);
      }
      tabDiv.appendChild(headerRow);

      // Rows container.
      const rowsContainer = document.createElement("div");
      rowsContainer.style.marginTop = "10px";
      tab.rows.forEach(row => {
        const rowDiv = document.createElement("div");
        rowDiv.className = "row";

        const rowHeading = document.createElement("input");
        rowHeading.type = "text";
        rowHeading.placeholder = "Row Heading";
        rowHeading.value = row.heading;
        rowHeading.addEventListener("input", () => { 
          row.heading = rowHeading.value; 
          updatePreview(); 
        });
        rowDiv.appendChild(rowHeading);

        const rowContent = document.createElement("textarea");
        rowContent.rows = 2;
        rowContent.placeholder = "Row Content";
        rowContent.value = row.content;
        rowContent.addEventListener("input", () => { 
          row.content = rowContent.value; 
          updatePreview(); 
        });
        rowDiv.appendChild(rowContent);

        // Remove row button if more than one row.
        if (tab.rows.length > 1) {
          const removeRowBtn = document.createElement("button");
          removeRowBtn.textContent = "Remove Row";
          removeRowBtn.className = "remove small-btn";
          removeRowBtn.addEventListener("click", () => {
            removeRowFromTab(tab, row.id);
            renderTabs();
            updatePreview();
          });
          rowDiv.appendChild(removeRowBtn);
        }
        rowsContainer.appendChild(rowDiv);
      });
      tabDiv.appendChild(rowsContainer);

      const addRowBtn = document.createElement("button");
      addRowBtn.textContent = "Add Row";
      addRowBtn.className = "small-btn";
      addRowBtn.addEventListener("click", () => {
        addRowToTab(tab);
        renderTabs();
        updatePreview();
      });
      tabDiv.appendChild(addRowBtn);

      container.appendChild(tabDiv);
    });

    // Disable add tab button if max reached.
    document.getElementById("addTab").disabled = (tabs.length >= maxTabs);
    updatePreview();
  }

  // Render optional sections.
  function renderOptSections() {
    const container = document.getElementById("optContainer");
    container.innerHTML = "";
    optSections.forEach(opt => {
      const optDiv = document.createElement("div");
      optDiv.style.border = "1px solid #ccc";
      optDiv.style.padding = "10px";
      optDiv.style.marginBottom = "10px";
      optDiv.dataset.optId = opt.id;

      const headingInput = document.createElement("input");
      headingInput.type = "text";
      headingInput.placeholder = "Optional Heading";
      headingInput.value = opt.heading;
      headingInput.addEventListener("input", () => { 
        opt.heading = headingInput.value; 
        updatePreview(); 
      });
      optDiv.appendChild(headingInput);

      const contentInput = document.createElement("textarea");
      contentInput.rows = 2;
      contentInput.placeholder = "Optional Content";
      contentInput.value = opt.content;
      contentInput.addEventListener("input", () => { 
        opt.content = contentInput.value; 
        updatePreview(); 
      });
      optDiv.appendChild(contentInput);

      const removeOptBtn = document.createElement("button");
      removeOptBtn.textContent = "Remove";
      removeOptBtn.className = "remove small-btn";
      removeOptBtn.addEventListener("click", () => {
        optSections = optSections.filter(o => o.id !== opt.id);
        renderOptSections();
        updatePreview();
      });
      optDiv.appendChild(removeOptBtn);

      container.appendChild(optDiv);
    });
    document.getElementById("addOpt").disabled = (optSections.length >= maxOpts);
    updatePreview();
  }

  // Initial creation: one tab by default.
  createTab();
  renderTabs();
  renderOptSections();

  // Wire up the "Add Tab" button.
  document.getElementById("addTab").addEventListener("click", () => {
    createTab();
  });

  // Optional sections add button.
  document.getElementById("addOpt").addEventListener("click", () => {
    const newOpt = { id: optCounter++, heading: "", content: "" };
    optSections.push(newOpt);
    renderOptSections();
  });

  // Update live preview.
  function updatePreview() {
    document.getElementById("previewCategory").textContent = document.getElementById("category").value;
    document.getElementById("previewDepartment").textContent = document.getElementById("department").value;
    document.getElementById("previewTitle").textContent = document.getElementById("title").value;
    document.getElementById("previewDescription").textContent = document.getElementById("description").value;
    document.getElementById("previewHeader").style.background = document.getElementById("headingColor").value;

    // Render tab navigation.
    const nav = document.getElementById("previewTabNav");
    nav.innerHTML = "";
    tabs.forEach((tab, index) => {
      const btn = document.createElement("button");
      btn.textContent = tab.name;
      btn.className = index === 0 ? "active" : "";
      btn.addEventListener("click", () => renderTabContent(tab));
      nav.appendChild(btn);
    });
    // Default: show first tab content.
    if (tabs.length) renderTabContent(tabs[0]);

    // Render optional sections.
    const optDiv = document.getElementById("previewOptional");
    optDiv.innerHTML = "";
    if (optSections.length > 0) {
      optSections.forEach(opt => {
        const h = document.createElement("div");
        h.style.fontWeight = "bold";
        h.textContent = opt.heading;
        const p = document.createElement("div");
        p.style.color = "gray";
        p.textContent = opt.content;
        optDiv.appendChild(h);
        optDiv.appendChild(p);
      });
    }
  }

  // Render rows of a given tab in the preview.
  function renderTabContent(tab) {
    // Mark active tab.
    document.querySelectorAll("#previewTabNav button").forEach((btn, idx) => {
      btn.classList.toggle("active", tabs[idx].id === tab.id);
    });
    const contentDiv = document.getElementById("previewTabContent");
    contentDiv.innerHTML = "";
    tab.rows.forEach(row => {
      const h = document.createElement("div");
      h.style.fontSize = "14px";
      h.style.color = "gray";
      h.textContent = row.heading;
      const p = document.createElement("div");
      p.style.fontWeight = "bold";
      p.style.fontSize = "16px";
      p.textContent = row.content;
      contentDiv.appendChild(h);
      contentDiv.appendChild(p);
    });
  }

  // Listen to header and color changes.
  document.querySelectorAll("#category, #department, #title, #description, #headingColor")
    .forEach(el => el.addEventListener("input", updatePreview));

  // Generate embed link.
  document.getElementById("generateLink").addEventListener("click", () => {
    const params = new URLSearchParams();
    params.set("cat", document.getElementById("category").value);
    params.set("dept", document.getElementById("department").value);
    params.set("title", document.getElementById("title").value);
    params.set("desc", document.getElementById("description").value);
    params.set("headColor", document.getElementById("headingColor").value);
    // Encode tabs array as JSON.
    const tabsData = tabs.map(tab => ({
      name: tab.name,
      rows: tab.rows.map(r => ({ heading: r.heading, content: r.content }))
    }));
    params.set("tabs", JSON.stringify(tabsData));

    // Encode optional sections.
    params.set("opt_sections", JSON.stringify(optSections.map(opt => ({ heading: opt.heading, content: opt.content }))));
    
    const embedUrl = window.location.origin + window.location.pathname.replace('editor.html', 'widget.html') + "?" + params.toString();
    document.getElementById("embedLinkContainer").innerHTML =
      `<strong>Embed URL:</strong> <a href="${embedUrl}" target="_blank">${embedUrl}</a>`;
  });

  updatePreview();
</script>
</body>
</html>
